# SPDX-FileCopyrightText: Copyright (c) 2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

# Test docker-compose file for running Isaac Teleop tests with CloudXR
# Extends the base CloudXR compose and adds test runner service
#
# Note: Run with a different project name to isolate volumes from dev environment:
#   docker compose -p isaacteleop-test -f docker-compose.yaml -f docker-compose.test.yaml up
#
# This creates volumes like "isaacteleop-test_openxr-volume" instead of "cloudxr_openxr-volume"
#
# NOTE: Must be used with -f docker-compose.yaml -f docker-compose.test.yaml
# (Docker Compose's include: directive doesn't allow service overrides)

services:
  # Override cloudxr-runtime for CI: accept EULA, use runc + deploy block for
  # hook-based GPU injection (the base file's runtime: nvidia is unavailable on
  # CI runners where the nvidia runtime is not registered).
  cloudxr-runtime:
    runtime: runc
    environment:
      - ACCEPT_EULA=Y
      - NV_CXR_ENABLE_PUSH_DEVICES=${NV_CXR_ENABLE_PUSH_DEVICES}
      - NV_DEVICE_PROFILE=Quest3
      - VK_LOADER_DEBUG=all
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [ gpu ]

  # Test runner container
  # Build with: docker build -t isaacteleop-tests:latest -f deps/cloudxr/Dockerfile.test .
  isaacteleop-tests:
    image: isaacteleop-tests:latest
    pull_policy: never
    network_mode: host
    depends_on:
      cloudxr-runtime:
        condition: service_healthy
    environment:
      - NV_CXR_RUNTIME_DIR=/cloudxr-test/run
      - XR_RUNTIME_JSON=/cloudxr-test/openxr_cloudxr.json
      - CXR_PYTHON_GPU_TESTS=${CXR_PYTHON_GPU_TESTS:-}
      - CXR_NATIVE_GPU_TESTS=${CXR_NATIVE_GPU_TESTS:-}
    volumes:
      - openxr-volume:/cloudxr-test/:ro
    working_dir: /app/tests
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -e
        echo "=========================================="
        echo "Isaac Teleop Test Runner"
        echo "=========================================="
        echo ""
        echo "XR_RUNTIME_JSON: $${XR_RUNTIME_JSON}"
        echo "CXR_PYTHON_GPU_TESTS: $${CXR_PYTHON_GPU_TESTS}"
        echo "CXR_NATIVE_GPU_TESTS: $${CXR_NATIVE_GPU_TESTS}"
        echo ""

        PASSED=0
        FAILED=0
        FAILED_TESTS=""

        # Run Python tests
        if [ -n "$${CXR_PYTHON_GPU_TESTS}" ]; then
            echo "=========================================="
            echo "Running Python Tests"
            echo "=========================================="
            IFS=',' read -ra TESTS <<< "$${CXR_PYTHON_GPU_TESTS}"

            for test_script in "$${TESTS[@]}"; do
                test_script=$$(echo "$$test_script" | xargs)  # trim whitespace
                echo "----------------------------------------"
                echo "Running: $$test_script"
                echo "----------------------------------------"

                if python "$$test_script"; then
                    echo "✅ PASSED: $$test_script"
                    PASSED=$((PASSED + 1))
                else
                    echo "❌ FAILED: $$test_script"
                    FAILED=$((FAILED + 1))
                    FAILED_TESTS="$$FAILED_TESTS $$test_script"
                fi
                echo ""
            done
        fi

        # Run native C++ tests
        if [ -n "$${CXR_NATIVE_GPU_TESTS}" ]; then
            echo "=========================================="
            echo "Running Native C++ Tests"
            echo "=========================================="
            IFS=',' read -ra NATIVES <<< "$${CXR_NATIVE_GPU_TESTS}"

            for native_test in "$${NATIVES[@]}"; do
                native_test=$$(echo "$$native_test" | xargs)  # trim whitespace
                echo "----------------------------------------"
                echo "Running: $$native_test"
                echo "----------------------------------------"

                if /app/$$native_test; then
                    echo "✅ PASSED: $$native_test"
                    PASSED=$((PASSED + 1))
                else
                    echo "❌ FAILED: $$native_test"
                    FAILED=$((FAILED + 1))
                    FAILED_TESTS="$$FAILED_TESTS $$native_test"
                fi
                echo ""
            done
        fi

        echo "=========================================="
        echo "Test Results Summary"
        echo "=========================================="
        echo "Passed: $$PASSED"
        echo "Failed: $$FAILED"

        if [ $$FAILED -gt 0 ]; then
            echo "Failed tests:$$FAILED_TESTS"
            exit 1
        fi

        echo "✅ All tests passed!"
        exit 0
