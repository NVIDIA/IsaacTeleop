# SPDX-FileCopyrightText: Copyright (c) 2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

services:
  # CloudXR Runtime
  cloudxr-runtime:
    build:
      context: .
      dockerfile: Dockerfile.runtime
      args:
        CXR_RUNTIME_SDK_VERSION: ${CXR_RUNTIME_SDK_VERSION}
    container_name: cloudxr-runtime-${CXR_RUNTIME_SDK_VERSION}
    user: "${CXR_UID:-1000}:${CXR_GID:-1000}"
    network_mode: host
    healthcheck:
      test: ["CMD", "test", "-f", "/openxr/run/runtime_started"]
      interval: 1s
      timeout: 1s
      retries: 10
      start_period: 5s
    environment:
      - ACCEPT_EULA=${ACCEPT_CLOUDXR_EULA:-Y}
      - NV_CXR_ENABLE_PUSH_DEVICES=${NV_CXR_ENABLE_PUSH_DEVICES}
      - NV_CXR_ENABLE_TENSOR_DATA=${NV_CXR_ENABLE_TENSOR_DATA}
      - NV_DEVICE_PROFILE=${NV_DEVICE_PROFILE:-auto-webrtc}
    volumes:
      - openxr-volume:/openxr/

  # WebSocket SSL Proxy Service
  wss-proxy:
    build:
      context: .
      dockerfile: Dockerfile.wss-proxy
    container_name: cloudxr-wss-proxy-${CXR_WEB_SDK_VERSION}
    network_mode: host
    depends_on:
      cloudxr-runtime:
        condition: service_healthy
    environment:
      # Backend configuration (cloudxr-runtime WebRTC port)
      - BACKEND_HOST=localhost
      - BACKEND_PORT=49100
      # Proxy SSL port
      - PROXY_PORT=48322
      # Health check configuration
      - HEALTH_CHECK_INTERVAL=1s
      - HEALTH_CHECK_RISE=2
      - HEALTH_CHECK_FALL=3
    restart: unless-stopped

  # Web App Service (serves CloudXR.js web client; webxr_client mounted for live reload)
  web-app:
    build:
      context: .
      dockerfile: Dockerfile.web-app
      args:
        CXR_WEB_SDK_VERSION: ${CXR_WEB_SDK_VERSION}
    container_name: cloudxr-web-app-${CXR_WEB_SDK_VERSION}
    network_mode: host
    user: "${CXR_UID:-1000}:${CXR_GID:-1000}"
    volumes:
      - ./webxr_client:/app/webxr_client
    restart: unless-stopped

volumes:
  openxr-volume:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${CXR_HOST_VOLUME_PATH:-/tmp/cloudxr}
